<html>
  <head>
    <title>Observation Charts</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/chart-base.css">
    <style>
    #generated-chart {
      width: 100%;
    }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <h1>Observation Charts</h1>
      </div>

      <div class="row">
        <div class="col-md-3">

          <form>
            <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingSize">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseSize" aria-expanded="false" aria-controls="collapseSize">

                      Size & Scale

                    </a>
                  </h4>
                </div>
                <div id="collapseSize" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingSize">
                  <div class="panel-body">

                    <div class="form-group">
                      <label for="size-width">Width</label>
                      <input type="text" class="form-control" id="size-width" 
                        name="size.width" data-validator="int">
                      <p class="help-block">Pixel width expressed in whole numbers.</p>
                    </div>
                    <div class="form-group">
                      <label for="size-height">Height</label>
                      <input type="text" class="form-control" id="size-height" 
                        name="size.height" data-validator="int">
                      <p class="help-block">Pixel height expressed in whole numbers.</p>
                    </div>
                    <div class="form-group">
                      <label for="scale">Scale</label>
                      <input type="text" class="form-control" id="scale" 
                        name="scale" data-validator="int">
                      <p class="help-block">Whole number multiple of the chart scale. 1 is the full sky.</p>
                    </div>
                                  
                  </div>
                </div>
              </div>

              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingCenter">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseCenter" aria-expanded="false" aria-controls="collapseCenter">

                      Center

                    </a>
                  </h4>
                </div>
                <div id="collapseCenter" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingCenter">
                  <div class="panel-body">

                    <div class="radio">
                      <label>
                        <input type="radio" name="centerRadio" id="center-radec" value="option1">
                        Center in the sky
                      </label>
                      <p class="help-block">Right ascension and declination will center the chart on a given point in the sky.</p>
                    </div>

                    <div id="center-celestial" style="display: none;">
                      <div class="form-group">
                        <label for="center-ra">Right ascension</label>
                        <input type="text" class="form-control" id="center-ra"
                          name="center.ra" data-validator="int">
                      </div>
                      <div class="form-group">
                        <label for="center-dec">Declination</label>
                        <input type="text" class="form-control" id="center-dec"
                          name="center.dec" data-validator="int">
                      </div>
                    </div>

                    <div class="radio">
                      <label>
                        <input type="radio" name="centerRadio" id="center-location" value="location-datetime">
                        Center on the ground
                      </label>
                      <p class="help-block">Latitude and longitude on Earth, along with a date and time, will determine the center of the chart.</p>
                    </div>

                    <div id="center-geographic" style="display: none;">
                      <div class="form-group">
                        <label for="location-latitude">Latitude</label>
                        <input type="text" class="form-control" id="location-latitude"
                          name="location.latitude" data-validator="int">
                        <p class="help-block"></p>
                      </div>
                      <div class="form-group">
                        <label for="location-longitude">Longitude</label>
                        <input type="text" class="form-control" id="location-longitude"
                          name="location.longitude" data-validator="int">
                      </div>
                      <div class="form-group">
                        <label for="scale">Date Time</label>
                        <input type="text" class="form-control" id="location-datetime"
                          name="datetime" data-validator="datetime">
                      </div>
                    </div>

                  </div>
                </div>
              </div>

              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingFeatures">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseFeatures" aria-expanded="false" aria-controls="collapseFeatures">

                      Features

                    </a>
                  </h4>
                </div>
                <div id="collapseFeatures" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingFeatures">
                  <div class="panel-body">

                    <!--
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="zoomable" name="zoom.zoomable" data-validator="boolean">
                        Zoomable
                      </label>
                    </div>
                    -->

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="ecliptic" name="ecliptic" data-validator="boolean">
                        Draw ecliptic
                      </label>
                    </div>

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="zenith" name="zenith.show" data-validator="boolean">
                        Draw zenith
                      </label>
                    </div>

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="graticule" name="graticule" data-validator="boolean">
                        Draw graticule 
                      </label>
                    </div>

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="information" name="information" data-validator="boolean">
                        Draw direction labels
                      </label>
                    </div>
                    
                    <!--

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="brightstar-override" name="override.brightstars" data-validator="boolean">
                        Label bright stars 
                      </label>
                      <p class="help-block">Bright stars with names will always be labeled</p>
                    </div>

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="messier-override" name="override.messier" data-validator="boolean">
                        Include Messier objects
                      </label>
                      <p class="help-block">Messier objects will always be shown</p>
                    </div>
                    
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="interesting-override" name="override.interesting" data-validator="boolean">
                        Include interesting objects  
                      </label>
                      <p class="help-block">"Intersting" (according to SEDS) deep sky objects will always be shown</p>
                    </div>
                    -->

                  </div>
                </div>
              </div>

              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingSolar">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseSolar" aria-expanded="false" aria-controls="collapseSolar">

                      Solar System

                    </a>
                  </h4>
                </div>
                <div id="collapseSolar" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingSolar">
                  <div class="panel-body">

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="sun" name="solar.sun" data-validator="boolean">
                        Draw sun
                      </label>
                    </div>

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="moon" name="solar.moon" data-validator="boolean">
                        Draw moon
                      </label>
                    </div>

                    <div class="checkbox disabled">
                      <label>
                        <input type="checkbox" id="planets" name="solar.planets" data-validator="boolean" disabled>
                        Draw planets
                      </label>
                    </div>
                        
                  </div>
                </div>
              </div>

              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingConstellations">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseConstellations" aria-expanded="false" aria-controls="collapseConstellations">

                      Constellations

                    </a>
                  </h4>
                </div>
                <div id="collapseConstellations" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingConstellations">
                  <div class="panel-body">

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="constellations-draw" name="constellations.draw" data-validator="boolean">
                        Draw
                      </label>
                    </div>
                    
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="constellations-label" name="constellations.label" data-validator="boolean">
                        Label
                      </label>
                    </div>
                        
                  </div>
                </div>
              </div>
              
              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingStars">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseStars" aria-expanded="false" aria-controls="collapseStars">

                      Stars

                    </a>
                  </h4>
                </div>
                <div id="collapseStars" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingStars">
                  <div class="panel-body">

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="stars-labelhover" name="stars.labelhover" data-validator="boolean">
                        Label on hover
                      </label>
                    </div>

                    <div class="form-group">
                      <label for="scale">Minimum Magnitude</label>
                      <input type="text" class="form-control" id="stars-magnitude" name="stars.magnitude" data-validator="int">
                    </div>
                        
                  </div>
                </div>
              </div>

              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingGalaxies">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseGalaxies" aria-expanded="false" aria-controls="collapseGalaxies">

                      Galaxies

                    </a>
                  </h4>
                </div>
                <div id="collapseGalaxies" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingGalaxies">
                  <div class="panel-body">

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="galaxies-labelhover" name="galaxies.labelhover" data-validator="boolean">
                        Label on hover
                      </label>
                    </div>

                    <div class="form-group">
                      <label for="scale">Minimum Magnitude</label>
                      <input type="text" class="form-control" id="galaxies-magnitude" name="galaxies.magnitude" data-validator="int">
                    </div>
                        
                  </div>
                </div>
              </div>

              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingOpenClusters">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOpenClusters" aria-expanded="false" aria-controls="collapseOpenClusters">

                      Open Clusters

                    </a>
                  </h4>
                </div>
                <div id="collapseOpenClusters" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOpenClusters">
                  <div class="panel-body">

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="openclusters-labelhover" name="openclusters.labelhover" data-validator="boolean">
                        Label on hover
                      </label>
                    </div>

                    <div class="form-group">
                      <label for="scale">Minimum Magnitude</label>
                      <input type="text" class="form-control" id="openclusters-magnitude" name="openclusters.magnitude" data-validator="int">
                    </div>
                        
                  </div>
                </div>
              </div>
              
              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingGlobularClusters">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseGlobularClusters" aria-expanded="false" aria-controls="collapseGlobularClusters">

                      Globular Clusters

                    </a>
                  </h4>
                </div>
                <div id="collapseGlobularClusters" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingGlobularClusters">
                  <div class="panel-body">

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="globularclusters-labelhover" name="globularclusters.labelhover" data-validator="boolean">
                        Label on hover
                      </label>
                    </div>

                    <div class="form-group">
                      <label for="scale">Minimum Magnitude</label>
                      <input type="text" class="form-control" id="globularclusters-magnitude" name="globularclusters.magnitude" data-validator="int">
                    </div>
                        
                  </div>
                </div>
              </div> 

              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingPlanetaryNebulas">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapsePlanetaryNebulas" aria-expanded="false" aria-controls="collapsePlanetaryNebulas">

                      Planetary Nebulas

                    </a>
                  </h4>
                </div>
                <div id="collapsePlanetaryNebulas" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingPlanetaryNebulas">
                  <div class="panel-body">

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="planetarynebulas-labelhover" name="planetarynebulas.labelhover" data-validator="boolean">
                        Label on hover
                      </label>
                    </div>

                    <div class="form-group">
                      <label for="scale">Minimum Magnitude</label>
                      <input type="text" class="form-control" id="planetarynebulas-magnitude" name="planetarynebulas.magnitude" data-validator="int">
                    </div>
                        
                  </div>
                </div>
              </div> 

              <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="headingBrightNebulas">
                  <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseBrightNebulas" aria-expanded="false" aria-controls="collapseBrightNebulas">

                      Bright Nebulas

                    </a>
                  </h4>
                </div>
                <div id="collapseBrightNebulas" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingBrightNebulas">
                  <div class="panel-body">

                    <div class="checkbox">
                      <label>
                        <input type="checkbox" id="brightnebulas-labelhover" name="brightnebulas.labelhover" data-validator="boolean">
                        Label on hover
                      </label>
                    </div>

                    <div class="form-group">
                      <label for="scale">Minimum Magnitude</label>
                      <input type="text" class="form-control" id="brightnebulas-magnitude" name="brightnebulas.magnitude" data-validator="int">
                    </div>
                        
                  </div>
                </div>
              </div> 

            </div>

            <!--
            <div class="pull-right">
              <button id="save-button" type="button" class="btn btn-success">Save as File</button>
              <button id="save-button" type="button" class="btn btn-success">Permalink</button>
            </div>
            -->

          </form>
         
        </div>
        <div class="col-md-9">
        <div id="generated-chart">
        </div>
      </div>

      <div class="row" id="settings">

      </div>
    <script src="js/d3.min.js" charset="utf-8"></script>
    <script src="js/date.min.js" charset="utf-8"></script>
    <script src="js/jquery.min.js" charset="utf-8"></script>
    <script src="js/bootstrap.min.js" charset="utf-8"></script>
    <script src="js/chart.js" charset="utf-8"/>
    <script></script>
    <script>

        var defaultOptions = {
            size: {
                width: 620,
                height: 620
            },
            scale: 1, 
            datetime: '',
            location: {
                latitude: 40.7528000,
                longitude: -73.9765222
            },
            center: {
                ra: undefined,
                dec: undefined
            },

            zoom: {
                zoomable: false,
            },
            graticule: true,
            zenith: {
                show: true,
            },
            ecliptic: true,
            information: true,

            solar: {
                moon: true,
                sun: true,
                planets: true
            },

            constellations: {
                label: true,
                draw: true
            },

            stars: {
                magnitude: 5,
                labelhover: false
            },

            galaxies: {
                magnitude: 10,
                labelhover: true
            },
            
            openclusters: {
                magnitude: 6,
                labelhover: true
            },

            globularclusters: {
                magnitude: 8,
                labelhover: true
            },

            planetarynebulas: {
                magnitude: 12,
                scale: [10,6],
                labelhover: true
            },

            brightnebulas: {
                magnitude: 12,
                labelhover: true
            },

            override: {
                brightstars: true,
                interesting: true,
                messier: true
            },

            overrides: $.extend({}, 
                                ObservationChart.BrightStarOverridess, 
                                ObservationChart.MessierOverrides, 
                                ObservationChart.InterestingObjectOverrides)

        };

        var options = defaultOptions 

        // var other = JSON.parse(atob(window.location.hash.slice(1)));
        var chart = new ObservationChart('#generated-chart', options);

        // Set a form field with the option name to the value
        var apply_option = function(option, value){
            var field = $('input[name="' + option + '"]');
            if (option == 'stars.magnitude') {
              console.log('input[name="' + option + '"]', field)
            }
            if (field.attr('type') == 'text'){
                field.val(value);
            } else if (field.attr('type') == 'checkbox') {
                field.prop('checked', value);
            }
        }

        // Set all relevant form fields to their option values
        var apply_options = function(options, prefix) {
            if (typeof prefix != 'undefined') {
                prefix += '.';
            } else {
                prefix = '';
            }

            for (option in options) {
                if ((typeof options[option] == 'string') || 
                    (typeof options[option] == 'number') ||
                    (typeof options[option] == 'boolean')) {
                    // console.log(prefix + option, options[option])
                    apply_option(prefix + option, options[option]);
                } else if(typeof options[option] == 'object' ) {
                    var n1 = option;
                    apply_options(options[n1], prefix + n1);
                }
            }
        }

        // Set an option in the options object to the value based on the key
        var set_option = function(options, key, value) {
            // Update the option
            eval("options." + key + "=" + value);

            // Update the chart
            chart.update(options);
        };

        // Handle the configuration form
        // Change the options anytime the form fields change
        $('form :input').on('change', function() {
          console.log("form change");
          var validator = $(this).attr('data-validator');
          var valid = false;
          var validator_msg = ""

          var option = $(this).attr('name');
          var value = $(this).val();

          // Validate the field
          if (validator == 'int') {
              var v = $(this).val()
              if (v >>> 0 === parseInt(v))
                  value = v
          } else if (validator == 'datetime') {

          } else if (validator == 'boolean') {
              if ($(this).is(":checked"))
                value = true;
              else
                value = false;
          }

          // Change the field state and set the option
          if (value != undefined) {
              $(this).parent().removeClass('has-error');
              set_option(options, option, value);
          } else {
              $(this).parent().addClass('has-error');
          }
        });

        // Specific form fields

        // Toggle centering based on radio selection
        $('#center-radec').click(function() {
            $('#center-geographic').hide();
            $('#center-celestial').show();
            options.location.latitude = undefined;
            options.location.longitude = undefined;
            options.datetime = undefined;
            apply_options(options);
            chart.update(options);
        });
        $('#center-location').click(function() {
            $('#center-celestial').hide();
            $('#center-geographic').show();
            options.center.ra = undefined;
            options.center.dec = undefined;
            apply_options(options);
            chart.update(options);
        });
        if ((options.location.latitude != undefined) && 
            (options.location.longitude != undefined)) {
            $('input#center-location').click();
        } else {
            $('input#center-radec').click();
        }

        var applyOverrides = function() {
            console.log("apply overrides");
            options.overrides = {};
            if (options.override.brightstars)
                $.extend(options.overrides, ObservationChart.BrightStarOverridess);
            if (options.override.messier)
                $.extend(options.overrides, ObservationChart.MessierOverrides);
            if (options.override.interesting)
                $.extend(options.overrides, ObservationChart.InterestingObjectOverrides);
        };
        $('#brightstar-override').change(applyOverrides);
        $('#messier-override').change(applyOverrides);
        $('#interesting-override').change(applyOverrides);
        applyOverrides();

        apply_options(options);

    </script>
  </body>
</html>

